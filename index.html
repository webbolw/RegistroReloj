import React, { useState, useEffect } from 'react';
import { Calendar, Save, Download, Clock, DollarSign, Smartphone, MapPin } from 'lucide-react';
import * as XLSX from 'xlsx';

const SalesTracker = () => {
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [sales, setSales] = useState({});
  const [formData, setFormData] = useState({
    celular: '',
    modelo: '',
    capital: '',
    venta: '',
    envio: ''
  });

  // Cargar datos del localStorage al iniciar
  useEffect(() => {
    const savedSales = localStorage.getItem('watchSales');
    if (savedSales) {
      setSales(JSON.parse(savedSales));
    }
  }, []);

  // Guardar en localStorage cuando cambian las ventas
  useEffect(() => {
    localStorage.setItem('watchSales', JSON.stringify(sales));
  }, [sales]);

  // Calcular ganancia autom√°ticamente
  const ganancia = formData.venta && formData.capital ? 
    parseFloat(formData.venta) - parseFloat(formData.capital) : 0;

  // Obtener ventas del d√≠a seleccionado
  const getDailySales = () => {
    return sales[selectedDate] || [];
  };

  // Manejar cambios en el formulario
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Guardar venta
  const handleSave = () => {
    if (!formData.celular || !formData.modelo || !formData.capital || !formData.venta) {
      alert('Por favor, completa todos los campos obligatorios');
      return;
    }

    const newSale = {
      id: Date.now(),
      fecha: selectedDate,
      celular: formData.celular,
      modelo: formData.modelo,
      capital: parseFloat(formData.capital),
      venta: parseFloat(formData.venta),
      ganancia: ganancia,
      envio: formData.envio
    };

    setSales(prev => ({
      ...prev,
      [selectedDate]: [...(prev[selectedDate] || []), newSale]
    }));

    // Limpiar formulario
    setFormData({
      celular: '',
      modelo: '',
      capital: '',
      venta: '',
      envio: ''
    });

    alert('Venta guardada exitosamente');
  };

  // Exportar a Excel
  const handleExport = () => {
    const dailySales = getDailySales();
    
    if (dailySales.length === 0) {
      alert('No hay ventas para exportar en la fecha seleccionada');
      return;
    }

    const exportData = dailySales.map(sale => ({
      'Fecha': sale.fecha,
      'Celular': sale.celular,
      'Modelo': sale.modelo,
      'Capital': sale.capital,
      'Venta': sale.venta,
      'Ganancia': sale.ganancia,
      'Env√≠o': sale.envio
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Ventas');
    
    XLSX.writeFile(wb, `ventas_${selectedDate}.xlsx`);
  };

  // Eliminar venta
  const handleDelete = (saleId) => {
    if (confirm('¬øEst√°s seguro de que deseas eliminar esta venta?')) {
      setSales(prev => ({
        ...prev,
        [selectedDate]: prev[selectedDate].filter(sale => sale.id !== saleId)
      }));
    }
  };

  const dailySales = getDailySales();
  const totalGanancia = dailySales.reduce((sum, sale) => sum + sale.ganancia, 0);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex items-center justify-center mb-4">
            <Clock className="w-8 h-8 text-indigo-600 mr-3" />
            <h1 className="text-3xl font-bold text-gray-800">Registro de Ventas de Relojes</h1>
          </div>
          
          {/* Selector de fecha */}
          <div className="flex items-center justify-center">
            <Calendar className="w-5 h-5 text-indigo-600 mr-2" />
            <input
              type="date"
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
              className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
        </div>

        <div className="grid lg:grid-cols-2 gap-6">
          {/* Formulario de registro */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">Nueva Venta</h2>
            
            <div className="space-y-4">
              <div>
                <label className="flex items-center text-sm font-medium text-gray-700 mb-1">
                  <Smartphone className="w-4 h-4 mr-1" />
                  N√∫mero de Celular *
                </label>
                <input
                  type="tel"
                  name="celular"
                  value={formData.celular}
                  onChange={handleInputChange}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Ej: +591 12345678"
                />
              </div>

              <div>
                <label className="flex items-center text-sm font-medium text-gray-700 mb-1">
                  <Clock className="w-4 h-4 mr-1" />
                  Modelo de Reloj *
                </label>
                <input
                  type="text"
                  name="modelo"
                  value={formData.modelo}
                  onChange={handleInputChange}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Ej: Rolex Submariner"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="flex items-center text-sm font-medium text-gray-700 mb-1">
                    <DollarSign className="w-4 h-4 mr-1" />
                    Capital (Bs) *
                  </label>
                  <input
                    type="number"
                    name="capital"
                    value={formData.capital}
                    onChange={handleInputChange}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="0.00"
                    step="0.01"
                  />
                </div>

                <div>
                  <label className="flex items-center text-sm font-medium text-gray-700 mb-1">
                    <DollarSign className="w-4 h-4 mr-1" />
                    Venta (Bs) *
                  </label>
                  <input
                    type="number"
                    name="venta"
                    value={formData.venta}
                    onChange={handleInputChange}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="0.00"
                    step="0.01"
                  />
                </div>
              </div>

              <div>
                <label className="text-sm font-medium text-gray-700 mb-1 block">
                  Ganancia (Bs)
                </label>
                <div className={`w-full border rounded-lg px-3 py-2 bg-gray-50 ${ganancia >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold`}>
                  {ganancia.toFixed(2)}
                </div>
              </div>

              <div>
                <label className="flex items-center text-sm font-medium text-gray-700 mb-1">
                  <MapPin className="w-4 h-4 mr-1" />
                  Destino de Env√≠o
                </label>
                <input
                  type="text"
                  name="envio"
                  value={formData.envio}
                  onChange={handleInputChange}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Ej: La Paz, Bolivia"
                />
              </div>

              <button
                onClick={handleSave}
                className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center font-medium"
              >
                <Save className="w-4 h-4 mr-2" />
                Guardar Venta
              </button>
            </div>
          </div>

          {/* Lista de ventas del d√≠a */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold text-gray-800">
                Ventas del {new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES')}
              </h2>
              {dailySales.length > 0 && (
                <button
                  onClick={handleExport}
                  className="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center text-sm font-medium"
                >
                  <Download className="w-4 h-4 mr-1" />
                  Descargar Excel
                </button>
              )}
            </div>

            {dailySales.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                <Clock className="w-12 h-12 mx-auto mb-2 opacity-50" />
                <p>No hay ventas registradas para esta fecha</p>
              </div>
            ) : (
              <>
                <div className="space-y-3 mb-4 max-h-96 overflow-y-auto">
                  {dailySales.map((sale) => (
                    <div key={sale.id} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                      <div className="flex justify-between items-start mb-2">
                        <div className="font-medium text-gray-800">{sale.modelo}</div>
                        <button
                          onClick={() => handleDelete(sale.id)}
                          className="text-red-500 hover:text-red-700 text-sm"
                        >
                          ‚úï
                        </button>
                      </div>
                      <div className="text-sm text-gray-600 space-y-1">
                        <div>üì± {sale.celular}</div>
                        <div>üí∞ Capital: {sale.capital.toFixed(2)} Bs | Venta: {sale.venta.toFixed(2)} Bs</div>
                        <div className={`font-medium ${sale.ganancia >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          üìà Ganancia: {sale.ganancia.toFixed(2)} Bs
                        </div>
                        {sale.envio && <div>üìç {sale.envio}</div>}
                      </div>
                    </div>
                  ))}
                </div>
                
                <div className="border-t pt-4">
                  <div className="flex justify-between items-center font-semibold text-lg">
                    <span>Total del d√≠a:</span>
                    <span className={totalGanancia >= 0 ? 'text-green-600' : 'text-red-600'}>
                      {totalGanancia.toFixed(2)} Bs
                    </span>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default SalesTracker;
